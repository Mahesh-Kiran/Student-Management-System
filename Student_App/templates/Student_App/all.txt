"""
ASGI config for My_Project project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'My_Project.settings')

application = get_asgi_application()
"""
Django settings for My_Project project.

Generated by 'django-admin startproject' using Django 4.2.7.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/4.2/ref/settings/
"""

from pathlib import Path
import os

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/4.2/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = os.environ.get('SECRET_KEY', 'django-insecure-3hch&_4d@*(911p9i6yfjr^d-j&&p(*kyd$#zj#ek@dbdo*^qo')
# SECURITY WARNING: don't run with debug turned on in production!
# DEBUG = os.environ.get('DEBUG', 'False') == 'True'
DEBUG = os.environ.get('DEBUG', 'True') == 'True'
ALLOWED_HOSTS = ['*']
CSRF_TRUSTED_ORIGINS = ['https://student-management-system-production-c799.up.railway.app']
# CSRF_COOKIE_SECURE = True

CSRF_COOKIE_SECURE = not DEBUG

# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'Student_App'
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware', 
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'My_Project.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'My_Project.wsgi.application'


# Database
# https://docs.djangoproject.com/en/4.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/4.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/4.2/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/4.2/howto/static-files/

STATIC_URL = '/static/'  
STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')
STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

# Default primary key field type
# https://docs.djangoproject.com/en/4.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

"""
URL configuration for My_Project project.

The `urlpatterns` list routes URLs to views. For more information please see:
    https://docs.djangoproject.com/en/4.2/topics/http/urls/
Examples:
Function views
    1. Add an import:  from my_app import views
    2. Add a URL to urlpatterns:  path('', views.home, name='home')
Class-based views
    1. Add an import:  from other_app.views import Home
    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
Including another URLconf
    1. Import the include() function: from django.urls import include, path
    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
"""
from django.contrib import admin
from django.urls import path,include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('Student_App.urls'))
]
"""
WSGI config for My_Project project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/4.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'My_Project.settings')

application = get_wsgi_application()
from django.apps import AppConfig


class StudentAppConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'Student_App'
from django import forms
from .models import Student


class StudentForm(forms.ModelForm):
    class Meta:
        model = Student
        fields = [
            'batch_no', 'first_name', 'last_name', 'email',
            'mobile', 'age', 'dob', 'course', 'cgpa',
            'college', 'fee', 'admission_date', 'address'
        ]
        labels = {
            'batch_no': 'Batch No',
            'first_name': 'First Name',
            'last_name': 'Last Name',
            'email': 'Email',
            'mobile': 'Phone No',
            'age': 'Age',
            'dob': 'Date of Birth',
            'course': 'Course',
            'cgpa': 'CGPA',
            'college': 'College',
            'fee': 'Fee',
            'admission_date': 'Admission Date',
            'address': 'Address',
        }
        widgets = {
            'batch_no': forms.TextInput(attrs={'class': 'form-control'}),
            'first_name': forms.TextInput(attrs={'class': 'form-control'}),
            'last_name': forms.TextInput(attrs={'class': 'form-control'}),
            'email': forms.EmailInput(attrs={'class': 'form-control'}),
            'mobile': forms.TextInput(attrs={'class': 'form-control'}),
            'age': forms.NumberInput(attrs={'class': 'form-control'}),
            'dob': forms.DateInput(attrs={'class': 'form-control', 'type': 'date'}),
            'course': forms.TextInput(attrs={'class': 'form-control'}),
            'cgpa': forms.NumberInput(attrs={'class': 'form-control', 'step': '0.01', 'min': '0', 'max': '10'}),
            'college': forms.TextInput(attrs={'class': 'form-control'}),
            'fee': forms.NumberInput(attrs={'class': 'form-control'}),
            'admission_date': forms.DateInput(attrs={'class': 'form-control', 'type': 'date'}),
            'address': forms.Textarea(attrs={'class': 'form-control', 'rows': 3}),
        }from django.db import models
from django.core.validators import RegexValidator
from django.utils.timezone import now

class Student(models.Model):
    student_pin = models.AutoField(primary_key=True)
    first_name = models.CharField(max_length=50)
    last_name = models.CharField(max_length=50)
    email = models.EmailField(max_length=100)
    course = models.CharField(max_length=50)
    mobile = models.CharField(max_length=10, validators=[RegexValidator(r'^\d{10}$')])
    age = models.IntegerField()
    dob = models.DateField(default=now)  # Use current date as default value for dob
    batch_no = models.IntegerField(default=21124)
    college = models.CharField(max_length=100, default='T.R.R. College of Technology')
    cgpa = models.FloatField()
    fee = models.PositiveIntegerField(default=0)  # Set default value for fee to 0
    admission_date = models.DateField(default=now)  # Use current date as default value for admission_date
    address = models.TextField(default='')

    def __str__(self):
        return f'Student: {self.first_name} {self.last_name}'
from django.test import TestCase

# Create your tests here.
from django.urls import path
from . import views

urlpatterns = [
    path('', views.index, name='index'),
    path('<int:id>/', views.view_student, name='view_student'),
    path('add/', views.add, name='add'),
    path('edit/<int:id>/', views.edit, name='edit'),
    path('delete/<int:id>/', views.delete, name='delete'),
    path('api/add-student/', views.api_add_student, name='api_add_student'),
]from django.http import HttpResponseRedirect, HttpResponse
from django.shortcuts import render, get_object_or_404
from django.urls import reverse
from .models import Student
from .forms import StudentForm
from django.db.models import Q
from django.contrib import messages
from django.core.paginator import Paginator
from django.views.decorators.csrf import csrf_exempt
import hashlib
import json
import uuid


def index(request):
    all_students = Student.objects.all()
    search_query = request.GET.get('search', '')

    if search_query:
        students = all_students.filter(
            Q(first_name__icontains=search_query) |
            Q(last_name__icontains=search_query) |
            Q(email__icontains=search_query) |
            Q(course__icontains=search_query)
        )
        num_records = students.count() 
    else:
        students = all_students
        num_records = all_students.count() 

    paginator = Paginator(students, 5)
    page_number = request.GET.get('page', 1)
    page_obj = paginator.get_page(page_number)

    student_data = list(all_students.values('student_pin', 'first_name', 'last_name', 'cgpa'))
    etag_value = hashlib.md5(json.dumps(student_data, default=str).encode()).hexdigest()
    etag_value = f'"{etag_value}"'

    if request.META.get('HTTP_IF_NONE_MATCH') == etag_value:
        return HttpResponse(status=304)

    response = render(request, 'Student_App/index.html', {
        'Student_App': page_obj,
        'page_obj': page_obj,
        'search_query': search_query,
        'num_records': num_records  
    })

    response['ETag'] = etag_value
    return response

@csrf_exempt
def api_add_student(request):
    if request.method == 'POST':
        try:
            data = json.loads(request.body)
        except json.JSONDecodeError:
            return JsonResponse({'error': 'Invalid JSON'}, status=400)

        # ── IDEMPOTENCY CHECK ──────────────────────────
        idempotency_key = request.headers.get('Idempotency-Key')
        if not idempotency_key:
            return JsonResponse({'error': 'Idempotency-Key header required'}, status=400)

        # Check if this key was already used
        cache_key = f"idempotency_{idempotency_key}"
        existing = request.session.get(cache_key)
        if existing:
            # Return the SAME response as the first request — not an error
            return JsonResponse({'message': 'Already processed', 'student': existing}, status=200)
        # ───────────────────────────────────────────────

        form = StudentForm(data)
        if form.is_valid():
            student = form.save()
            response_data = {
                'student_pin': student.student_pin,
                'name': f"{student.first_name} {student.last_name}",
                'email': student.email,
                'course': student.course
            }
            # Store result against this key so retries get same response
            request.session[cache_key] = response_data
            return JsonResponse({'message': 'Student created', 'student': response_data}, status=201)
        else:
            return JsonResponse({'errors': form.errors}, status=400)

    return JsonResponse({'error': 'Method not allowed'}, status=405)

def view_student(request, id):
    return HttpResponseRedirect(reverse('index'))

def add(request):
    if request.method == 'GET':
        form = StudentForm()
        idempotency_key = str(uuid.uuid4())
        request.session['idempotency_key'] = idempotency_key
        return render(request, 'Student_App/add.html', {
            'form': form,
            'idempotency_key': idempotency_key
        })

    if request.method == 'POST':
        submitted_key = request.POST.get('idempotency_key')
        session_key = request.session.get('idempotency_key')

        if not submitted_key or submitted_key != session_key:
            messages.error(request, 'Duplicate submission detected. Please try again.')
            # Generate fresh key and redirect
            return HttpResponseRedirect(reverse('add'))

        # Clear key immediately after first valid use
        del request.session['idempotency_key']

        form = StudentForm(request.POST)
        if form.is_valid():
            new_student = form.save()
            student_name = f"{new_student.first_name} {new_student.last_name}"
            # Generate new key for next use
            new_key = str(uuid.uuid4())
            request.session['idempotency_key'] = new_key
            return render(request, 'Student_App/add.html', {
                'form': StudentForm(),
                'success': True,
                'student_name': student_name,
                'idempotency_key': new_key
            })
        else:
            # On validation failure, generate new key so form is usable again
            new_key = str(uuid.uuid4())
            request.session['idempotency_key'] = new_key
            messages.error(request, 'Invalid details. Please re-enter the information.')
            return render(request, 'Student_App/add.html', {
                'form': form,
                'idempotency_key': new_key
            })
        

def edit(request, id):
    student = get_object_or_404(Student, pk=id)
    if request.method == 'POST':
        form = StudentForm(request.POST, instance=student)
        if form.is_valid():
            updated_student = form.save()
            student_name = f"{updated_student.first_name} {updated_student.last_name}"
            return render(request, 'Student_App/edit.html', {
                'form': form,
                'success': True,
                'student_name': student_name
            })
        else:
            messages.error(request, 'Invalid details. Please correct the errors below.')
            return render(request, 'Student_App/edit.html', {'form': form})
    else:
        form = StudentForm(instance=student)
    return render(request, 'Student_App/edit.html', {'form': form})


def delete(request, id):
    if request.method == 'POST':
        student = get_object_or_404(Student, pk=id)
        student.delete()
    return HttpResponseRedirect(reverse('index')){% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="icon" href="{% static 'css/Icon.png' %}" type="image/x-icon">
    <title>EduHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet">
    <link href="{% static 'css/style.css' %}" rel="stylesheet">
</head>

<body class="d-flex flex-column min-vh-100">
    <nav class="navbar navbar-expand-lg bg-light" data-bs-theme="light">
        <div class="container-fluid"> <a class="navbar-brand" href="{% url 'index' %}"> <b>Edu-Hub <span><small
                            style="font-size:10px;">Student Portal</small></span></b> </a> <button
                class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarColor03"
                aria-controls="navbarColor03" aria-expanded="false" aria-label="Toggle navigation"> <span
                    class="navbar-toggler-icon"></span> </button>
            <div class="collapse navbar-collapse justify-content-between" id="navbarColor03">
                <ul class="navbar-nav">
                    <li class="nav-item"> <a class="nav-link" href="{% url 'index' %}"><i
                                class="fa-solid fa-house fa-lg"></i> Home <span class="visually-hidden">(current)</span>
                        </a> </li>
                    <li class="nav-item"> <a class="nav-link" href="{% url 'index' %}" id="scrollTarget"><i
                                class="fa-solid fa-rectangle-list fa-lg "></i> Show All</a> </li>
                    <li class="nav-item"> <a class="nav-link" href="{% url 'add' %}"><i
                                class="fa-solid fa-circle-plus fa-lg"></i> ADD </a> </li>
                </ul>
                <form class="d-flex" method="GET" action="/">
                    <input id="searchInput" name="search" class="form-control me-sm-2" type="search"
                        placeholder="Search Student" value="{{ search_query }}">
                    <button class="btn btn-secondary my-2 my-sm-0" type="submit">Search</button>
                </form>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        {% block body %}
        {% endblock %}
    </div>
    <footer class="mt-auto mb-4">
        <div class="text-center">
            <span>
                Copyright &copy;
                <script>document.write(new Date().getFullYear())</script>
            </span><br>
            <Span>Number of Students: <strong>{{ num_records }}</strong></Span>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.querySelector('#scrollTarget').addEventListener('click', function (event) {
            event.preventDefault();
            document.querySelector('#scrl').scrollIntoView({ behavior: 'smooth', block: 'start' });
        });
    </script>
</body>

</html>{% extends "Student_App/base.html" %}

{% block body %}
<h3 class="text-center m-4">Update Student</h3>
  {% if success %}
    <div class="alert alert-success text-center" role="alert">
      <a href="{% url 'index' %}" class="alert-link">
        Successfully Updated Student: <strong style="color: blue;text-transform: uppercase;">{{ student_name }}</strong></a>
    </div>
  {% else %}
    <div class="row justify-content-center">
      <div class="col-8">
        <div class="card bg-light mb-3">
          <div class="card-header">
            <i class="fa-regular fa-pen-to-square fa-lg"></i> Update Student Records
          </div>
          <div class="card-body">
            <form action="" method="POST">
              {% csrf_token %}
              {{ form.as_p }}
              <button type="submit" class="btn btn-primary">Update</button>
              <a href="{% url 'index' %}" class="btn btn-secondary">Cancel</a>
            </form>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}{% extends "Student_App/base.html" %}

{% block body %}
<div class="row">
    <div class="col-12">
        {% if Student_App %}
        <div class="card bg-light ms-4 me-4 mb-4">
            <div class="card-header" id="scrl">
                <i class="fa-solid fa-list-ul fa-lg"></i> Student Records
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th scope="col">Student Pin</th>
                                <th scope="col">First Name</th>
                                <th scope="col">Last Name</th>
                                <th scope="col">Email</th>
                                <th scope="col">Course</th>
                                <th scope="col">CGPA</th>
                                <th scope="col">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in Student_App %}
                            <tr class="table-info">
                                <td>{{ student.student_pin }}</td>
                                <td>{{ student.first_name }}</td>
                                <td>{{ student.last_name }}</td>
                                <td>{{ student.email }}</td>
                                <td>{{ student.course }}</td>
                                <td>{{ student.cgpa }}</td>
                                <td>
                                    <!-- INFO BUTTON -->
                                    <button type="button" class="btn btn-success me-1"
                                        data-bs-toggle="modal"
                                        data-bs-target="#myModal{{ student.student_pin }}">
                                        <i class="fa-solid fa-circle-info fa-lg"></i>
                                    </button>

                                    <!-- Info Modal — INSIDE the for loop -->
                                    <div class="modal fade" id="myModal{{ student.student_pin }}"
                                        tabindex="-1"
                                        aria-labelledby="infoLabel{{ student.student_pin }}"
                                        aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h3 style="color: #ff007b;" class="modal-title"
                                                        id="infoLabel{{ student.student_pin }}">
                                                        {{ student.first_name }} {{ student.last_name }}
                                                    </h3>
                                                    <button type="button" class="btn-close"
                                                        data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <ul class="list-unstyled">
                                                        <li style="color:#ff6600;">Batch No: <strong>{{ student.batch_no }}</strong></li>
                                                        <li style="color:#ff6600;">Student Pin: <strong>{{ student.student_pin }}</strong></li>
                                                        <li style="color:#ff6600;">Name: <strong>{{ student.first_name }} {{ student.last_name }}</strong></li>
                                                        <li style="color:#ff6600;">Age: <strong>{{ student.age }}</strong></li>
                                                        <li style="color:#ff6600;">Date of Birth: <strong>{{ student.dob }}</strong></li>
                                                        <li style="color:#ff6600;">Email: <strong>{{ student.email }}</strong></li>
                                                        <li style="color:#ff6600;">Phone No: <strong>{{ student.mobile }}</strong></li>
                                                        <li style="color:#ff6600;">Course: <strong>{{ student.course }}</strong></li>
                                                        <li style="color:#ff6600;">CGPA: <strong>{{ student.cgpa }}</strong></li>
                                                        <li style="color:#ff6600;">College: <strong>{{ student.college }}</strong></li>
                                                        <li style="color:#ff6600;">Fee: <strong>{{ student.fee }}</strong></li>
                                                        <li style="color:#ff6600;">Admission Date: <strong>{{ student.admission_date }}</strong></li>
                                                        <li style="color:#ff6600;">Address: <strong>{{ student.address }}</strong></li>
                                                    </ul>
                                                </div>
                                                <div class="modal-footer">
                                                    <button type="button" class="btn btn-primary"
                                                        data-bs-dismiss="modal">Close</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Edit Button -->
                                    <a class="btn btn-warning me-1" href="{% url 'edit' student.student_pin %}">
                                        <i class="fa-solid fa-pen-to-square fa-lg"></i>
                                    </a>

                                    <!-- Delete Button -->
                                    <button type="button" class="btn btn-danger"
                                        data-bs-toggle="modal"
                                        data-bs-target="#delete{{ student.student_pin }}">
                                        <i class="fa-solid fa-trash-can fa-lg"></i>
                                    </button>

                                    <!-- Delete Confirmation Modal — INSIDE the for loop -->
                                    <div class="modal fade" id="delete{{ student.student_pin }}"
                                        tabindex="-1"
                                        aria-labelledby="deleteLabel{{ student.student_pin }}"
                                        aria-hidden="true">
                                        <div class="modal-dialog" role="document">
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h3 class="modal-title"
                                                        id="deleteLabel{{ student.student_pin }}">
                                                        {{ student.first_name }} {{ student.last_name }}
                                                    </h3>
                                                    <button type="button" class="btn-close"
                                                        data-bs-dismiss="modal" aria-label="Close"></button>
                                                </div>
                                                <div class="modal-body">
                                                    <p style="color:#f54c40;">Are you sure you want to delete this student?</p>
                                                </div>
                                                <div class="modal-footer">
                                                    <form action="{% url 'delete' student.student_pin %}" method="POST">
                                                        {% csrf_token %}
                                                        <input type="submit" class="btn btn-danger" value="Delete">
                                                    </form>
                                                    <button type="button" class="btn btn-secondary"
                                                        data-bs-dismiss="modal">Cancel</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </td>
                            </tr>
                            {% endfor %} <!-- ← endfor is HERE, after all modals -->
                        </tbody>
                    </table>

                    <!-- Pagination -->
                    {% if page_obj.has_other_pages %}
                    <nav class="mt-3">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}">Previous</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Previous</span>
                            </li>
                            {% endif %}

                            {% for num in page_obj.paginator.page_range %}
                            <li class="page-item {% if page_obj.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}&search={{ search_query }}">{{ num }}</a>
                            </li>
                            {% endfor %}

                            {% if page_obj.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ page_obj.next_page_number }}&search={{ search_query }}">Next</a>
                            </li>
                            {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">Next</span>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}

                </div>
            </div>
        </div>
        {% else %}
        <h5 class="alert alert-primary ms-4 me-4 mb-4">No Student Records Found</h5>
        {% endif %}
    </div>
</div>
{% endblock %}